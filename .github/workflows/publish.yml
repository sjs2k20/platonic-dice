name: Publish Package & Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            # Optional: only needed if you run tests/builds before publish
            # - run: npm install

            # --- PRE-FLIGHT CHECKS ---

            - name: Verify package.json version matches tag
              run: |
                  PKG_VERSION=$(node -p "require('./package.json').version")
                  TAG_VERSION=${GITHUB_REF#refs/tags/v}
                  echo "package.json version=$PKG_VERSION, git tag=$TAG_VERSION"
                  if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
                    echo "ERROR: Version mismatch! package.json=$PKG_VERSION, tag=$TAG_VERSION"
                    exit 1
                  fi

            - name: Check npm authentication
              run: npm whoami --registry=https://registry.npmjs.org/
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

            # --- PUBLISH TO NPMJS ---

            - name: Publish to npmjs.org
              run: |
                  TAG_VERSION=${GITHUB_REF_NAME#v}
                  set -e
                  npm publish --registry https://registry.npmjs.org/ --access public || {
                    if npm view platonic-dice@$TAG_VERSION >/dev/null 2>&1; then
                      echo "WARNING: Version $TAG_VERSION already exists on npm, continuing."
                    else
                      echo "ERROR: npm publish failed for another reason."
                      exit 1
                    fi
                  }
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

            # Optional GitHub Packages publish (will require scoped package)
            # # --- PUBLISH TO GITHUB PACKAGES ---

            # - name: Publish to GitHub Packages
            #   run: npm publish --registry https://npm.pkg.github.com/ --access public
            #   env:
            #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # --- CREATE GITHUB RELEASE ---

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
