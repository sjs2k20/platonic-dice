name: Publish Packages & Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  typecheck:
    name: Typecheck workspaces
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci --workspaces

      - name: Build core package (emit declarations)
        run: npm run -w @platonic-dice/core build

      # (debug steps removed)

      - name: Run TypeScript checks for workspace packages
        run: |
          set -euo pipefail
          echo "Looking for packages with tsconfig.json..."
          found=0
          for dir in packages/*; do
            if [ -f "$dir/tsconfig.json" ]; then
              echo "Found tsconfig in $dir, running tsc --noEmit"
              npx tsc -p "$dir/tsconfig.json" --noEmit
              found=1
            fi
          done
          if [ "$found" -eq 0 ]; then
            echo "No package tsconfig.json files found; skipping typecheck step."
          fi

  publish:
    needs: typecheck
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci --workspaces

      - name: Build core package
        run: npm run -w @platonic-dice/core build

      - name: Determine tag version
        id: tag
        run: |
          TAG_VERSION=${GITHUB_REF_NAME#v}
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT

      - name: Verify workspace package versions and publish matching packages
        run: |
          set -euo pipefail
          TAG_VERSION=${{ steps.tag.outputs.tag_version }}
          echo "Tag version: $TAG_VERSION"

          # Create a temporary npmrc so npm uses the token for npmjs.
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

          # Publish packages in deterministic order to respect inter-package deps
          PACKAGES=("packages/core" "packages/dice")

          for pkg in "${PACKAGES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              PKG_NAME=$(node -p "require('./$pkg/package.json').name")
              PKG_VERSION=$(node -p "require('./$pkg/package.json').version")
              echo "Found package: $PKG_NAME@$PKG_VERSION in $pkg"
              if [ "$PKG_VERSION" = "$TAG_VERSION" ]; then
                echo "Checking if $PKG_NAME@$PKG_VERSION already exists on npmjs.org"
                if npm view "$PKG_NAME@$PKG_VERSION" >/dev/null 2>&1; then
                  echo "Version $PKG_VERSION already exists on npm for $PKG_NAME, skipping publish."
                else
                  echo "Publishing $PKG_NAME from $pkg to npmjs.org"
                  pushd "$pkg"
                  # Ensure install/build step runs as necessary (prepublishOnly handles build)
                  npm publish --registry https://registry.npmjs.org/ --access public
                  popd
                fi
              else
                echo "Skipping $PKG_NAME (version mismatch)"
              fi
            else
              echo "Package path $pkg does not exist, skipping"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
