name: Publish Packages & Release

permissions:
  contents: write

on:
  push:
    tags:
      - "core-v*.*.*" # Core package releases
      - "types-core-v*.*.*" # Types package releases
      - "dice-v*.*.*" # Dice package releases
      # Note: Only publishable packages have tag patterns.

jobs:
  typecheck:
    name: Typecheck workspaces
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: "8.15.9"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: "8.15.9"

      - name: Enable Corepack and prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.9 --activate

      - name: Install dependencies
        run: pnpm -w install --frozen-lockfile

      - name: Build core package (emit declarations)
        run: pnpm --filter @platonic-dice/core run build

      - name: Build dice package (emit declarations)
        run: pnpm --filter @platonic-dice/dice run build

      - name: Run core external type-surface tests
        run: pnpm --filter @types/platonic-dice__core run test:types

      # (debug steps removed)

      - name: Run TypeScript checks for workspace packages
        run: |
          set -euo pipefail
          echo "Looking for packages with tsconfig.json..."
          found=0
          for dir in packages/*; do
            if [ -f "$dir/tsconfig.json" ]; then
              echo "Found tsconfig in $dir, running tsc --noEmit"
              npx tsc -p "$dir/tsconfig.json" --noEmit
              found=1
            fi
          done
          if [ "$found" -eq 0 ]; then
            echo "No package tsconfig.json files found; skipping typecheck step."
          fi

  publish:
    needs: typecheck
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: "8.15.9"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: "8.15.9"

      - name: Enable Corepack and prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.9 --activate

      - name: Install dependencies
        run: pnpm -w install --frozen-lockfile

      - name: Build core package
        run: pnpm --filter @platonic-dice/core run build

      - name: Determine tag version
        id: tag
        run: |
          # Strip 'v' prefix and optional package prefix (core-v, types-core-v, dice-v)
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          TAG_VERSION="${TAG_VERSION#core-v}"
          TAG_VERSION="${TAG_VERSION#types-core-v}"
          TAG_VERSION="${TAG_VERSION#dice-v}"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $TAG_VERSION from tag: $GITHUB_REF_NAME"

          if [[ "${GITHUB_REF_NAME}" == core-v* ]]; then
            echo "target_packages=packages/core packages/types-core" >> $GITHUB_OUTPUT
            echo "Tag targets: packages/core + packages/types-core"
          elif [[ "${GITHUB_REF_NAME}" == types-core-v* ]]; then
            echo "target_packages=packages/types-core" >> $GITHUB_OUTPUT
            echo "Tag targets: packages/types-core"
          elif [[ "${GITHUB_REF_NAME}" == dice-v* ]]; then
            echo "target_packages=packages/dice" >> $GITHUB_OUTPUT
            echo "Tag targets: packages/dice"
          else
            echo "Unsupported tag format: ${GITHUB_REF_NAME}"
            exit 1
          fi

      - name: Verify tag targets and publish
        run: |
          set -euo pipefail
          TAG_VERSION=${{ steps.tag.outputs.tag_version }}
          TARGET_PACKAGES="${{ steps.tag.outputs.target_packages }}"
          echo "Tag version: $TAG_VERSION"
          echo "Target packages: $TARGET_PACKAGES"

          # Create a temporary npmrc so npm uses the token for npmjs.
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

          for pkg in $TARGET_PACKAGES; do
            if [ -f "$pkg/package.json" ]; then
              PKG_NAME=$(node -p "require('./$pkg/package.json').name")
              PKG_VERSION=$(node -p "require('./$pkg/package.json').version")
              PKG_PRIVATE=$(node -p "require('./$pkg/package.json').private || false")
              echo "Found package: $PKG_NAME@$PKG_VERSION in $pkg (private: $PKG_PRIVATE)"
              if [ "$PKG_PRIVATE" = "true" ]; then
                echo "Skipping $PKG_NAME (marked as private)"
                continue
              fi
              if [ "$PKG_VERSION" = "$TAG_VERSION" ]; then
                echo "Checking if $PKG_NAME@$PKG_VERSION already exists on npmjs.org"
                if npm view "$PKG_NAME@$PKG_VERSION" >/dev/null 2>&1; then
                  echo "Version $PKG_VERSION already exists on npm for $PKG_NAME, skipping publish."
                else
                  echo "Publishing $PKG_NAME from $pkg to npmjs.org"
                  pushd "$pkg"
                  # Ensure install/build step runs as necessary (prepublishOnly handles build)
                  npm publish --registry https://registry.npmjs.org/ --access public
                  popd
                fi
              else
                echo "Skipping $PKG_NAME (version mismatch)"
              fi
            else
              echo "Package path $pkg does not exist, skipping"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
